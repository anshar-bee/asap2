<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analisa Saham Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f2f5; 
        }
        .prose h4 {
          font-size: 1.125rem;
          font-weight: 600;
          margin-top: 1rem;
          margin-bottom: 0.5rem;
        }
    </style>
    <!-- React and Babel for JSX transpilation -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google GenAI -->
    <script type="module">
        import { GoogleGenAI } from 'https://esm.sh/@google/genai';
        window.GoogleGenAI = GoogleGenAI;
    </script>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.28.0"
  }
}
</script>
</head>
<body class="text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // --- Constants ---
        const GOOGLE_APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxwFxNhpOFF9cm1brOwAdpfvhjk-5l4g5pxX4EVtW1I1WexZmGWmWUKZjcuhQiwSU2X/exec';
        const PRICE_API_URL = 'https://script.google.com/macros/s/AKfycbzn_lUgPbqVeLFqGboZth6OYBmW6ZXnQamp7s78M6yoOZK98nkXTSO4XcTxyizWTAj57Q/exec';
        const ITEMS_PER_PAGE = 10;

        // --- Gemini Service ---
        const analyzeStocks = async (tickers) => {
            const ai = new window.GoogleGenAI({ apiKey: process.env.API_KEY });
            const prompt = `Anda adalah seorang analis teknikal dan fundamental ahli. Saya ingin Anda menganalisis dan membandingkan saham-saham berikut: ${tickers.join(', ')}. Untuk setiap saham, berikan analisis berdasarkan data terkini (asumsikan Anda memiliki akses ke data tersebut) yang mencakup: 1. Indikator Teknikal (RSI, Stochastic, MACD, MFI, Volume, Moving Average). 2. Aspek Fundamental (berita keuangan, ringkasan laporan perusahaan, analisis pasar umum). Setelah menganalisis setiap saham, berikan dua bagian kesimpulan. Pertama, bagian '**Urutan Rekomendasi**' yang berisi daftar urutan saham dari yang paling direkomendasikan (peringkat 1) hingga yang kurang direkomendasikan. Kedua, bagian '**Rekomendasi Utama**' yang menjelaskan secara ringkas saham mana yang menjadi pilihan teratas dan mengapa. Format jawaban Anda dengan heading tebal (menggunakan markdown **) untuk setiap saham dan juga untuk 'Urutan Rekomendasi' dan 'Rekomendasi Utama'.`;
            
            try {
                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: prompt,
                });
                return response.text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                if (error instanceof Error) {
                    throw new Error(`Gemini API Error: ${error.message}`);
                }
                throw new Error("An unknown error occurred while contacting the Gemini API.");
            }
        };

        // --- API Service ---
        async function handleResponse(response) {
            if (!response.ok) {
                let errorMsg = `HTTP error! status: ${response.status}`;
                try {
                    const errorBody = await response.json();
                    errorMsg = errorBody.message || errorMsg;
                } catch (e) { /* Ignore if body is not JSON */ }
                throw new Error(errorMsg);
            }
            return response.json();
        }

        const fetchManualStocks = async () => {
            try {
                const response = await fetch(`${GOOGLE_APP_SCRIPT_URL}?sheet=manual_tracking`);
                return await handleResponse(response);
            } catch (error) {
                console.error("Error fetching manual stocks:", error);
                throw new Error("Gagal mengambil data dari Google Sheets. Pastikan skrip Anda sudah di-deploy dengan benar.");
            }
        };

        const addManualStock = async (ticker, initial_price) => {
            try {
                const response = await fetch(GOOGLE_APP_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'addManualStock', data: { ticker, initial_price } }),
                });
                await handleResponse(response);
            } catch (error) {
                console.error("Error adding manual stock:", error);
                throw new Error("Gagal menambahkan saham ke Google Sheets.");
            }
        };

        const deleteManualStock = async (id) => {
            try {
                const response = await fetch(GOOGLE_APP_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'deleteManualStock', id: id }),
                });
                await handleResponse(response);
            } catch (error) {
                console.error("Error deleting manual stock:", error);
                throw new Error("Gagal menghapus saham dari Google Sheets.");
            }
        };

        const fetchCurrentPrice = async (ticker) => {
            try {
                const response = await fetch(`${PRICE_API_URL}?ticker=${ticker}`);
                const data = await handleResponse(response);
                return data.price && data.ticker ? data : null;
            } catch (error) {
                console.error(`Error fetching price for ${ticker}:`, error);
                return null;
            }
        };

        // --- Components ---
        const Loader = ({ isButtonLoader = false }) => {
            const sizeClasses = isButtonLoader ? 'w-5 h-5 border-2' : 'w-10 h-10 border-4';
            return <div className={`animate-spin rounded-full border-solid border-blue-500 border-t-transparent ${sizeClasses}`}></div>;
        };

        const Pagination = ({ currentPage, totalPages, onPageChange }) => {
            if (totalPages <= 1) return null;
            return (
                <div className="flex flex-col sm:flex-row justify-between items-center mt-4 px-6 pb-4 space-y-2 sm:space-y-0">
                    <button onClick={() => onPageChange(currentPage - 1)} disabled={currentPage === 1} className="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition disabled:opacity-50 disabled:cursor-not-allowed">&laquo; Sebelumnya</button>
                    <span className="text-sm text-gray-600">Halaman {currentPage} dari {totalPages}</span>
                    <button onClick={() => onPageChange(currentPage + 1)} disabled={currentPage === totalPages} className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed">Berikutnya &raquo;</button>
                </div>
            );
        };

        const Toast = ({ message, show }) => {
            const toastClasses = `fixed bottom-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white py-3 px-6 rounded-lg shadow-lg z-50 transition-all duration-300 ease-in-out ${show ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4 pointer-events-none'}`;
            return <div className={toastClasses}>{message}</div>;
        };
        
        const ConfirmationModal = ({ show, message, onConfirm, onCancel }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm mx-4">
                        <h3 className="text-lg font-bold text-gray-800 mb-4">Konfirmasi Aksi</h3>
                        <p className="text-gray-600 mb-6">{message}</p>
                        <div className="flex justify-end space-x-4">
                            <button onClick={onCancel} className="px-4 py-2 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300">Batal</button>
                            <button onClick={onConfirm} className="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Ya, Hapus</button>
                        </div>
                    </div>
                </div>
            );
        };

        const Header = () => {
            const [currentDate, setCurrentDate] = useState('');
            useEffect(() => {
                setCurrentDate(new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }));
            }, []);
            return (
                <header className="mb-8">
                    <div className="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-2xl shadow-lg space-y-4 md:space-y-0">
                        <div className="flex items-center space-x-4">
                            <div className="bg-blue-600 p-3 rounded-full"><i className="fas fa-chart-line text-white text-2xl"></i></div>
                            <div>
                                <h1 className="text-2xl md:text-3xl font-bold text-gray-900">Analisa Saham Pro</h1>
                                <p className="text-gray-500 text-sm">{currentDate}</p>
                            </div>
                        </div>
                        <div className="mt-4 md:mt-0 text-sm text-gray-600 flex items-center">
                            <i className="fab fa-google-drive mr-2 text-green-500"></i>
                            <span>Didukung oleh Gemini & Google Sheets</span>
                        </div>
                    </div>
                </header>
            );
        };

        const TabNavigation = ({ activeTab, setActiveTab }) => {
            const getTabClasses = (tabName) => `whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${activeTab === tabName ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`;
            return (
                <div className="mb-6"><div className="border-b border-gray-200"><nav className="-mb-px flex space-x-8" aria-label="Tabs">
                    <button className={getTabClasses('manual')} onClick={() => setActiveTab('manual')}>Analisis Manual</button>
                    <button className={getTabClasses('tracking')} onClick={() => setActiveTab('tracking')}>Lacak Manual</button>
                </nav></div></div>
            );
        };
        
        const ManualAnalysis = ({ showToast }) => {
            const [stockInput, setStockInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [analysisResult, setAnalysisResult] = useState('');

            const handleAnalysis = async () => {
                if (!stockInput.trim()) {
                    showToast("Silakan masukkan minimal satu kode saham."); return;
                }
                const tickers = stockInput.split(',').map(t => t.trim().toUpperCase()).filter(t => t);
                if (tickers.length === 0) {
                    showToast("Format input tidak valid. Contoh: TLKM, ASII"); return;
                }
                setIsLoading(true);
                setAnalysisResult('');
                try {
                    const result = await analyzeStocks(tickers);
                    const formattedResult = result.replace(/\*\*(.*?)\*\*/g, '<h4 class="text-lg font-semibold mt-4 mb-2 text-gray-800">$1</h4>').replace(/\*/g, '').replace(/\n/g, '<br />');
                    setAnalysisResult(formattedResult);
                } catch (error) {
                    const errorMessage = error instanceof Error ? error.message : 'Terjadi kesalahan tidak diketahui.';
                    setAnalysisResult(`<p class="text-red-500 text-center">Gagal menganalisis: ${errorMessage}</p>`);
                    showToast(`Gagal menganalisis: ${errorMessage}`);
                } finally {
                    setIsLoading(false);
                }
            };
            
            return (
                <section>
                    <div className="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 className="text-xl font-bold mb-2 text-gray-700">Analisis Saham Manual</h2>
                        <p className="text-sm text-gray-500 mb-6">Masukkan beberapa kode saham yang ingin Anda bandingkan, pisahkan dengan koma.</p>
                        <div>
                            <label htmlFor="manual-stock-input" className="block text-sm font-medium text-gray-700 mb-2">Kode Saham</label>
                            <textarea id="manual-stock-input" rows={3} className="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Contoh: TLKM, ASII, ADRO" value={stockInput} onChange={(e) => setStockInput(e.target.value)} disabled={isLoading} />
                        </div>
                        <div className="mt-4 text-right">
                            <button onClick={handleAnalysis} disabled={isLoading} className="w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-300 disabled:bg-blue-400 disabled:cursor-not-allowed flex items-center justify-center sm:inline-flex">
                                {isLoading ? (<><Loader isButtonLoader={true} /><span className="ml-2">Menganalisis...</span></>) : (<><i className="fas fa-search mr-2"></i> Bandingkan & Analisa</>)}
                            </button>
                        </div>
                    </div>
                    <div className="mt-8"><div className="bg-white p-6 rounded-2xl shadow-lg min-h-[10rem]">
                        {isLoading ? (<div className="flex flex-col items-center justify-center py-8"><Loader /><p className="mt-4 text-gray-500">AI sedang menganalisis...</p></div>) : analysisResult ? (<div className="prose max-w-none text-gray-600" dangerouslySetInnerHTML={{ __html: analysisResult }} />) : (<p className="text-center text-gray-500 pt-8">Hasil analisis perbandingan akan muncul di sini.</p>)}
                    </div></div>
                </section>
            );
        };

        const ManualTracking = ({ showToast, showModal }) => {
            const [stocks, setStocks] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isAdding, setIsAdding] = useState(false);
            const [newStockTicker, setNewStockTicker] = useState('');
            const [currentPage, setCurrentPage] = useState(1);

            const fetchData = useCallback(async () => {
                setIsLoading(true);
                try {
                    const manualStocks = await fetchManualStocks();
                    if (manualStocks.length === 0) {
                        setStocks([]);
                        setIsLoading(false);
                        return;
                    }
                    const pricePromises = manualStocks.map(stock => fetchCurrentPrice(stock.ticker));
                    const currentPrices = await Promise.all(pricePromises);
                    const displayData = manualStocks.map(stock => {
                        const priceData = currentPrices.find(p => p?.ticker === stock.ticker);
                        const currentPrice = priceData ? priceData.price : stock.initial_price;
                        const gain = stock.initial_price !== 0 ? ((currentPrice - stock.initial_price) / stock.initial_price) * 100 : 0;
                        return { ...stock, currentPrice, gain };
                    });
                    setStocks(displayData);
                } catch (error) {
                    const errorMessage = error instanceof Error ? error.message : 'Gagal memuat data.';
                    showToast(errorMessage);
                } finally {
                    setIsLoading(false);
                }
            }, [showToast]);

            useEffect(() => { fetchData(); }, [fetchData]);

            const handleAddStock = async () => {
                if (!newStockTicker.trim()) { showToast("Silakan masukkan kode saham."); return; }
                const ticker = newStockTicker.trim().toUpperCase();
                setIsAdding(true);
                try {
                    const priceData = await fetchCurrentPrice(ticker);
                    if (!priceData) throw new Error(`Saham ${ticker} tidak ditemukan atau API harga gagal.`);
                    await addManualStock(ticker, priceData.price);
                    showToast(`${ticker} berhasil ditambahkan.`);
                    setNewStockTicker('');
                    setCurrentPage(1);
                    fetchData();
                } catch (error) {
                    const errorMessage = error instanceof Error ? error.message : 'Gagal menambahkan saham.';
                    showToast(errorMessage);
                } finally {
                    setIsAdding(false);
                }
            };
            
            const handleDeleteStock = (id, ticker) => {
                showModal(`Apakah Anda yakin ingin menghapus ${ticker} dari daftar lacak?`, async () => {
                    try {
                        await deleteManualStock(id);
                        showToast(`${ticker} berhasil dihapus.`);
                        fetchData();
                    } catch (error) {
                        const errorMessage = error instanceof Error ? error.message : 'Gagal menghapus saham.';
                        showToast(errorMessage);
                    }
                });
            };

            const GainDisplay = ({ gain }) => {
                const gainClass = gain > 0 ? 'text-green-500' : gain < 0 ? 'text-red-500' : 'text-gray-500';
                const gainIcon = gain > 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                return (<span className={`font-semibold ${gainClass}`}> {gain > 0 ? '+' : ''}{gain.toFixed(2)}% {gain !== 0 && <i className={`fas ${gainIcon} ml-1 text-xs`}></i>}</span>);
            };

            const paginatedStocks = stocks.slice((currentPage - 1) * ITEMS_PER_PAGE, currentPage * ITEMS_PER_PAGE);
            const totalPages = Math.ceil(stocks.length / ITEMS_PER_PAGE);
            
            return (
                <section>
                    <div className="bg-white p-6 rounded-2xl shadow-lg mb-8">
                        <h2 className="text-xl font-bold mb-2 text-gray-700">Tambahkan Saham ke Daftar Lacak</h2>
                        <p className="text-sm text-gray-500 mb-6">Masukkan kode saham yang ingin Anda pantau performanya secara manual.</p>
                        <div className="flex flex-col sm:flex-row items-end space-y-2 sm:space-y-0 sm:space-x-4">
                            <div className="w-full">
                                <label htmlFor="manual-track-input" className="block text-sm font-medium text-gray-700 mb-1">Kode Saham</label>
                                <input type="text" id="manual-track-input" value={newStockTicker} onChange={(e) => setNewStockTicker(e.target.value)} disabled={isAdding} className="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Contoh: MDKA" />
                            </div>
                            <button onClick={handleAddStock} disabled={isAdding} className="w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300 flex-shrink-0 disabled:bg-blue-400 disabled:cursor-not-allowed flex items-center justify-center">
                                {isAdding ? <Loader isButtonLoader={true} /> : (<><i className="fas fa-plus mr-2"></i> Tambahkan</>)}
                            </button>
                        </div>
                    </div>
                    <div className="bg-white rounded-2xl shadow-lg overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left text-gray-500">
                                <thead className="text-xs text-gray-700 uppercase bg-gray-100"><tr>
                                    <th scope="col" className="px-6 py-3">Saham</th>
                                    <th scope="col" className="px-6 py-3">Tgl Ditambahkan</th>
                                    <th scope="col" className="px-6 py-3 text-right">Harga Awal</th>
                                    <th scope="col" className="px-6 py-3 text-right">Harga Terkini</th>
                                    <th scope="col" className="px-6 py-3 text-right">Gain (%)</th>
                                    <th scope="col" className="px-6 py-3 text-center">Aksi</th>
                                </tr></thead>
                                <tbody>
                                    {isLoading ? (<tr><td colSpan="6" className="text-center p-8"><Loader /></td></tr>) : paginatedStocks.length > 0 ? (paginatedStocks.map(stock => (
                                        <tr key={stock.id} className="bg-white border-b hover:bg-gray-50">
                                            <td className="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">{stock.ticker}</td>
                                            <td className="px-6 py-4">{new Date(stock.created_at).toLocaleDateString('id-ID')}</td>
                                            <td className="px-6 py-4 text-right">Rp {Math.round(stock.initial_price).toLocaleString('id-ID')}</td>
                                            <td className="px-6 py-4 text-right">Rp {Math.round(stock.currentPrice).toLocaleString('id-ID')}</td>
                                            <td className="px-6 py-4 text-right"><GainDisplay gain={stock.gain} /></td>
                                            <td className="px-6 py-4 text-center"><button onClick={() => handleDeleteStock(stock.id, stock.ticker)} className="text-red-500 hover:text-red-700"><i className="fas fa-trash"></i></button></td>
                                        </tr>
                                    ))) : (<tr><td colSpan="6" className="text-center p-8 text-gray-500">Belum ada saham yang dilacak.</td></tr>)}
                                </tbody>
                            </table>
                        </div>
                        <Pagination currentPage={currentPage} totalPages={totalPages} onPageChange={setCurrentPage} />
                    </div>
                </section>
            );
        };


        const App = () => {
            const [activeTab, setActiveTab] = useState('manual');
            const [toast, setToast] = useState({ show: false, message: '' });
            const [modal, setModal] = useState({ show: false, message: '', onConfirm: () => {} });

            const showToast = useCallback((message) => {
                setToast({ show: true, message });
                setTimeout(() => setToast({ show: false, message: '' }), 3000);
            }, []);

            const showModal = useCallback((message, onConfirm) => {
                setModal({ show: true, message, onConfirm });
            }, []);

            const hideModal = useCallback(() => {
                setModal({ show: false, message: '', onConfirm: () => {} });
            }, []);

            const handleConfirm = () => {
                modal.onConfirm();
                hideModal();
            };

            return (
                <React.Fragment>
                    <div className="container mx-auto p-4 md:p-8">
                        <Header />
                        <main>
                            <TabNavigation activeTab={activeTab} setActiveTab={setActiveTab} />
                            <div className={activeTab === 'manual' ? '' : 'hidden'}>
                                <ManualAnalysis showToast={showToast} />
                            </div>
                            <div className={activeTab === 'tracking' ? '' : 'hidden'}>
                                <ManualTracking showToast={showToast} showModal={showModal} />
                            </div>
                        </main>
                    </div>
                    <Toast message={toast.message} show={toast.show} />
                    <ConfirmationModal show={modal.show} message={modal.message} onConfirm={handleConfirm} onCancel={hideModal} />
                </React.Fragment>
            );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
